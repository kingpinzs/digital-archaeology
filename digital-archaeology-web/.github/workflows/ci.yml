# CI/CD Pipeline for Digital Archaeology
# Action Item #1 from Epic 3 Retrospective: Add WASM compilation to CI/CD
#
# Security: This workflow does not use any untrusted user input in run commands.
# All commands use only static strings and official action outputs.

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Build WASM modules
  build-wasm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: '3.1.51'
          actions-cache-folder: 'emsdk-cache'

      - name: Build Assembler WASM
        run: |
          cd src/micro4/wasm
          chmod +x build.sh
          ./build.sh
          ls -la *.wasm *.js

      - name: Build Emulator WASM
        run: |
          cd digital-archaeology-web/public/wasm
          chmod +x build-emulator.sh
          ./build-emulator.sh
          ls -la *.wasm *.js

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-modules
          path: |
            src/micro4/wasm/*.wasm
            src/micro4/wasm/*.js
            digital-archaeology-web/public/wasm/*.wasm
            digital-archaeology-web/public/wasm/*.js

  # Lint, type-check, and test
  test:
    runs-on: ubuntu-latest
    needs: build-wasm
    defaults:
      run:
        working-directory: digital-archaeology-web

    steps:
      - uses: actions/checkout@v4

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-modules
          path: .

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: digital-archaeology-web/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Run tests
        run: npm test -- --run --reporter=verbose

      - name: Verify test count
        run: |
          TEST_OUTPUT=$(npm test -- --run 2>&1)
          TEST_COUNT=$(echo "$TEST_OUTPUT" | grep -oP '\d+(?= passed)' | tail -1)
          echo "Test count: $TEST_COUNT"
          if [ "$TEST_COUNT" -lt 1000 ]; then
            echo "Warning: Test count dropped below 1000 (current: $TEST_COUNT)"
            exit 1
          fi
          echo "Test count check passed: $TEST_COUNT tests"

  # Build production bundle
  build:
    runs-on: ubuntu-latest
    needs: [build-wasm, test]
    defaults:
      run:
        working-directory: digital-archaeology-web

    steps:
      - uses: actions/checkout@v4

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-modules
          path: .

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: digital-archaeology-web/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: digital-archaeology-web/dist

  # Deploy to GitHub Pages (only on main branch push)
  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
